AMARCORD:

myMdC:
  #! configuration for myMdC
  user_id: 0000000000000000000000000000000000000000000
  user_secret: 0000000000000000000000000000000000000000000
  user_email: foo@cfel.de

# D. We should have 'filling values' in case a device disappears from the stream
Karabo_bridge:
  #! configuration for the Karabo bridge.
  #    identifier (str): `attributo` identifier
  #    source (str): EuXFEL source
  #    key (str): Value to extract
  #    description (str, optional): `attributo` description. Defaults to None.
  #    type (str, optional): The AMARCORD data type. Defaults to "decimal".
  #    store (bool, optional): Whether to store the value. Defaults to True.
  #    action (str, optional): Either "compute_arithmetic_mean", "compute_standard_deviation", "check_if_constant" or "store_last". Defaults to None.
  #    unit (str, optional): Unit of measurement. Defaults to None.
  #    filling_value (Any, optional): Filling value in case a source is missing. Defaults to None.
  version: 1
  client_endpoint: tcp://10.253.0.51:41014

  attributi_definition:
    run:
      # required to slice data from the bridge
      source: SPB_DAQ_DATA/DM/RUN_CONTROL

      index:
        description: Run index
        key: runDetails.runId.value

      number:
        description: Run number
        key: runNumber.value
        type: int

      timestamp_UTC_initial:
        description: Started at
        key: runDetails.beginAt.value
        type: datetime

      train_index_initial:
        description: Initial train
        key: runDetails.firstTrainId.value
        type: int

      trains_in_run:
        description: Number of trains
        key: runDetails.length.value
        type: int

    source:
      # data from the source
      # http://hdrmx.medsbio.org/manual/build/html/classes/base_classes/NXsource.html#nxsource
      source: SPB_RR_SYS/MDL/BUNCH_PATTERN
      action: check_if_constant

      bunch_charge:
        # D. Should AMARCORD key == Karabo key? If not, where do we store it?
        # -- this might be "description" + we add header
        key: sase1.charge.value
        type: decimal
        unit: nC

      # bunch_pattern:
      #   key: sase1.pulseIds.value

      number_of_bunches:
        key: sase1.nPulses.value

    # any detector
    # D. How to model detectors in the database?
    detector.XGM_XTD9:
      comment: X-ray intensity monitor
      action: compute_arithmetic_mean
      action_axis:

      SASE1_pulse_energy:
        source: SPB_XTD9_XGM/XGM/DOOCS:output
        key: data.intensitySa1TD
        type: decimal
        unit: microJoules

      SASE1_beam_position_x:
        source: SPB_XTD9_XGM/XGM/DOOCS:output
        key: data.xSa1TD
        type: decimal
        unit: millimeter # ?

      SASE1_beam_position_y:
        source: SPB_XTD9_XGM/XGM/DOOCS:output
        key: data.ySa1TD
        type: decimal
        unit: millimeter # ?

      SASE3_pulse_energy:
        source: SPB_XTD9_XGM/XGM/DOOCS:output
        key: data.intensitySa3TD
        type: decimal
        unit: microJoules

      SASE3_beam_position_x:
        source: SPB_XTD9_XGM/XGM/DOOCS:output
        key: data.xSa3TD
        type: decimal
        unit: mm # ?

      SASE3_beam_position_y:
        source: SPB_XTD9_XGM/XGM/DOOCS:output
        key: data.ySa3TD
        type: decimal
        unit: mm # ?

      Xray_wavelength_set:
        source: SPB_XTD9_XGM/XGM/DOOCS
        key: pulseEnergy.wavelengthUsed.value
        description: X-ray wavelength
        type: decimal
        unit: angstrom

    detector.ZYLA:
      comment: Optical imager
      source: SPB_EXP_ZYLA/CAM/1:output

      injector_image:
        key: data.image.data
        type: image
        action: store_last

    detector.AGIPD:
      comment: X-ray detector
      action: check_if_constant

      dark_run_type:
        source: SPB_DA_USR/MDL/AMARCORD_INFO
        key: darkExperiment.value

      dark_run_index:
        source: SPB_DA_USR/MDL/AMARCORD_INFO
        key: darkRunNumber.value

      gain_setting:
        source: SPB_IRU_AGIPD1M1/MDL/FPGA_COMP
        key: gainMode.value
        type: decimal

      position_z:
        source: SPB_IRU_AGIPD1M/MOTOR/Z_STEPPER
        key: actualPosition.value
        type: decimal
        unit: mm

      position_quadrant1_x:
        source: SPB_IRU_AGIPD1M/MDL/MOVER
        key: q1.x.value
        type: decimal
        unit: mm

      position_quadrant1_y:
        source: SPB_IRU_AGIPD1M/MDL/MOVER
        key: q1.y.value
        type: decimal
        unit: mm

      position_quadrant2_x:
        source: SPB_IRU_AGIPD1M/MDL/MOVER
        key: q2.x.value
        type: decimal
        unit: mm

      position_quadrant2_y:
        source: SPB_IRU_AGIPD1M/MDL/MOVER
        key: q2.y.value
        type: decimal
        unit: mm

      position_quadrant3_x:
        source: SPB_IRU_AGIPD1M/MDL/MOVER
        key: q3.x.value
        type: decimal
        unit: mm

      position_quadrant3_y:
        source: SPB_IRU_AGIPD1M/MDL/MOVER
        key: q3.y.value
        type: decimal
        unit: mm

      position_quadrant4_x:
        source: SPB_IRU_AGIPD1M/MDL/MOVER
        key: q4.x.value
        type: decimal
        unit: mm

      position_quadrant4_y:
        source: SPB_IRU_AGIPD1M/MDL/MOVER
        key: q4.y.value
        type: decimal
        unit: mm

      # position_quadrant1_xy:
      #   build_attributo: (position_quadrant1_x, position_quadrant1_y)
      #   unit: mm
      #   action: check_if_constant

    # any device
    # D. How to model this in the database?
    device.attenuator_SASE1_XTD2:
      comment: attenuator
      source: SA1_XTD2_ATT/MDL/MAIN
      action: check_if_constant

      attenuator1_inserted:
        key: actual.value.isInsertedAct1
      attenuator1_thickness:
        key: actual.value.thicknessAct1
        unit: micrometer
      attenuator1_material:
        key: actual.value.materialAct1
      attenuator1_absorption:
        key: actual.value.absorptionAct1
        type: decimal
        unit: percent

      attenuator2_inserted:
        key: actual.value.isInsertedAct2
      attenuator2_thickness:
        key: actual.value.thicknessAct2
      attenuator2_material:
        key: actual.value.materialAct2
      attenuator2_absorption:
        key: actual.value.absorptionAct2
        type: decimal
        unit: percent

      attenuator3_inserted:
        key: actual.value.isInsertedAct3
      attenuator3_thickness:
        key: actual.value.thicknessAct3
      attenuator3_material:
        key: actual.value.materialAct3
      attenuator3_absorption:
        key: actual.value.absorptionAct3
        type: decimal
        unit: percent

      attenuator4_inserted:
        key: actual.value.isInsertedAct4
      attenuator4_thickness:
        key: actual.value.thicknessAct4
      attenuator4_material:
        key: actual.value.materialAct4
      attenuator4_absorption:
        key: actual.value.absorptionAct4
        type: decimal
        unit: percent

      attenuator5_inserted:
        key: actual.value.isInsertedAct5
      attenuator5_thickness:
        key: actual.value.thicknessAct5
      attenuator5_material:
        key: actual.value.materialAct5
      attenuator5_absorption:
        key: actual.value.absorptionAct5
        type: decimal
        unit: percent

      attenuator6_inserted:
        key: actual.value.isInsertedAct6
      attenuator6_thickness:
        key: actual.value.thicknessAct6
      attenuator6_material:
        key: actual.value.materialAct6
      attenuator6_absorption:
        key: actual.value.absorptionAct6
        type: decimal
        unit: percent

      attenuator7_inserted:
        key: actual.value.isInsertedAct7
      attenuator7_thickness:
        key: actual.value.thicknessAct7
      attenuator7_material:
        key: actual.value.materialAct7
      attenuator7_absorption:
        key: actual.value.absorptionAct7
        type: decimal
        unit: percent

      attenuator8_inserted:
        key: actual.value.isInsertedAct8
      attenuator8_thickness:
        key: actual.value.thicknessAct8
      attenuator8_material:
        key: actual.value.materialAct8
      attenuator8_absorption:
        key: actual.value.absorptionAct8
        type: decimal
        unit: percent

      attenuator9_inserted:
        key: actual.value.isInsertedAct9
      attenuator9_thickness:
        key: actual.value.thicknessAct9
      attenuator9_material:
        key: actual.value.materialAct9
      attenuator9_absorption:
        key: actual.value.absorptionAct9
        type: decimal
        unit: percent

      transmission:
        key: actual.value.transmission
        type: decimal
        unit: percent

    device.attenuator_SPB_XTD9:
      comment: attenuator
      source: SPB_XTD9_ATT/MDL/MAIN
      action: check_if_constant

      attenuator1_increment:
        key: actual.value.incrementRod1
      attenuator1_thickness:
        key: actual.value.thicknessRod1
        type: decimal
        unit: micrometer
      attenuator1_material:
        key: actual.value.materialRod1
      attenuator1_absorption:
        key: actual.value.absorptionRod1
        type: decimal
        unit: percent

      attenuator2_increment:
        key: actual.value.incrementRod2
      attenuator2_thickness:
        key: actual.value.thicknessRod2
      attenuator2_material:
        key: actual.value.materialRod2
      attenuator2_absorption:
        key: actual.value.absorptionRod2
        type: decimal
        unit: percent

      attenuator3_increment:
        key: actual.value.incrementRod3
      attenuator3_thickness:
        key: actual.value.thicknessRod3
      attenuator3_material:
        key: actual.value.materialRod3
      attenuator3_absorption:
        key: actual.value.absorptionRod3
        type: decimal
        unit: percent

      attenuator4_increment:
        key: actual.value.incrementRod4
      attenuator4_thickness:
        key: actual.value.thicknessRod4
      attenuator4_material:
        key: actual.value.materialRod4
      attenuator4_absorption:
        key: actual.value.absorptionRod4
        type: decimal
        unit: percent

      transmission:
        key: actual.value.transmission
        type: decimal
        unit: percent

    device.sample_delivery_manifold_valves:
      source: SPB_IRU_LIQUIDJET/MDL/MANIFOLD_VALVES
      action: check_if_constant

      config0_valve_group_name:
        key: valvesConfigTable.value[0].valveGroupName
      config0_valve_indices:
        key: valvesConfigTable.value[0].valveIds
        action_axis: 0
      config0_positions:
        key: valvesConfigTable.value[0].nPositions
      config0_labels:
        key: valvesConfigTable.value[0].labels

      config1_valve_group_name:
        key: valvesConfigTable.value[1].valveGroupName
      config1_valve_indices:
        key: valvesConfigTable.value[1].valveIds
        action_axis: 0
      config1_positions:
        key: valvesConfigTable.value[1].nPositions
      config1_labels:
        key: valvesConfigTable.value[1].labels

      config2_valve_group_name:
        key: valvesConfigTable.value[2].valveGroupName
      config2_valve_indices:
        key: valvesConfigTable.value[2].valveIds
        action_axis: 0
      config2_positions:
        key: valvesConfigTable.value[2].nPositions
      config2_labels:
        key: valvesConfigTable.value[2].labels

      groupA_position:
        key: GROUPA.currentPosition.value
      sample1_position:
        key: SPB_IRU_LIQUIDJETVALVEVALVE_SAMPLE_1.currentPosition.value
      sample2_position:
        key: SPB_IRU_LIQUIDJETVALVEVALVE_SAMPLE_2.currentPosition.value

    device.sample_delivery_rate:
      source: SPB_BIO_SYS/PUMP/HPLC
      action: compute_arithmetic_mean
      action_axis:

      pump_a_flow_value:
        key: a.flow.value
        type: decimal
        unit: microliter/minute
      pump_a_value:
        key: a.volume.value
        unit: unknown

      pump_b_flow_value:
        key: b.volume.value
        type: decimal
        unit: microliter/minute
      pump_b_value:
        key: b.flow.value
        unit: unknown

      pump_c_flow_value:
        key: c.flow.value
        type: decimal
        unit: microliter/minute
      pump_c_value:
        key: c.volume.value
        unit: unknown

      pump_d_flow_value:
        key: d.flow.value
        type: decimal
        unit: microliter/minute
      pump_d_value:
        key: d.volume.value
        unit: unknown

    device.sample_delivery_injector:
      source: SPB_IRU_INJMOV/MOTOR/Z
      action: check_if_constant

      position_z:
        key: actualPosition.value
        unit: mm

  # explicitly ignore the following entries
  ignore_entry:
    SPB_EXP_ZYLA/CAM/1:output:
      - data.image.type
      - data.image.dimensions
      - data.image.dimensionTypes
      - data.image.rOIOffsets
      - data.image.binning
      - data.image.rotation
      - data.image.flipX
      - data.image.flipY
      - data.image.bitsPerPixel
      - data.image.encoding
      - data.image.dimensionScales
      - data.image.geometry.alignment.offsets
      - data.image.geometry.alignment.rotations
      - data.image.geometry.tileId
      - data.image.header

    SPB_XTD9_XGM/XGM/DOOCS:output:
      - data.intensitySigmaTD
      - data.intensityAUXTD
      - data.xTD
      - data.xSigmaTD
      - data.yTD
      - data.ySigmaTD
      - data.intensitySa1SigmaTD
      - data.intensityAUXSa1TD
      - data.xSa1SigmaTD
      - data.ySa1SigmaTD
      - data.intensitySa3SigmaTD
      - data.intensityAUXSa3TD
      - data.xSa3SigmaTD
      - data.ySa3SigmaTD
      - data.intensityTD

    SPB_DAQ_DATA/DM/RUN_CONTROL:
      - runNumber.timestamp.tid
      - runNumber.timestamp.timestamp
      - runDetails.runId.timestamp.tid
      - runDetails.runId.timestamp.timestamp
      - runDetails.beginAt.timestamp.tid
      - runDetails.beginAt.timestamp.timestamp
      - runDetails.lastTrainId.value
      - runDetails.lastTrainId.timestamp.tid
      - runDetails.lastTrainId.timestamp.timestamp
      - runDetails.length.timestamp.tid
      - runDetails.length.timestamp.timestamp
      - runDetails.firstTrainId.timestamp.tid
      - runDetails.firstTrainId.timestamp.timestamp

    SPB_RR_SYS/MDL/BUNCH_PATTERN:
      - sase1.nPulses.timestamp.tid
      - sase1.nPulses.timestamp.timestamp
      - sase1.charge.timestamp.tid
      - sase1.charge.timestamp.timestamp
      - sase1.pulseIds.timestamp.tid
      - sase1.pulseIds.timestamp.timestamp

    SA1_XTD2_ATT/MDL/MAIN:
      - actual.timestamp.tid
      - actual.timestamp.timestamp

    SPB_XTD9_ATT/MDL/MAIN:
      - actual.timestamp.tid
      - actual.timestamp.timestamp

    SPB_IRU_AGIPD1M/MOTOR/Z_STEPPER:
      - actualPosition.timestamp.tid
      - actualPosition.timestamp.timestamp

    SPB_IRU_AGIPD1M1/MDL/FPGA_COMP:
      - gain.value
      - gain.timestamp.tid
      - gain.timestamp.timestamp
      - gainMode.timestamp.tid
      - gainMode.timestamp.timestamp

    SPB_IRU_INJMOV/MOTOR/Z:
      - actualPosition.timestamp.tid
      - actualPosition.timestamp.timestamp

    SPB_BIO_SYS/PUMP/HPLC:
      - c.flow.timestamp.tid
      - c.flow.timestamp.timestamp
      - c.volume.timestamp.tid
      - c.volume.timestamp.timestamp
      - a.volume.timestamp.tid
      - a.volume.timestamp.timestamp
      - a.flow.timestamp.tid
      - a.flow.timestamp.timestamp
      - b.flow.timestamp.tid
      - b.flow.timestamp.timestamp
      - b.volume.timestamp.tid
      - b.volume.timestamp.timestamp
      - d.flow.timestamp.tid
      - d.flow.timestamp.timestamp
      - d.volume.timestamp.tid
      - d.volume.timestamp.timestamp

    SPB_IRU_LIQUIDJET/MDL/MANIFOLD_VALVES:
      - SPB_IRU_LIQUIDJETVALVEVALVE_SAMPLE_1.currentPosition.timestamp.tid
      - SPB_IRU_LIQUIDJETVALVEVALVE_SAMPLE_1.currentPosition.timestamp.timestamp
      - valvesConfigTable.timestamp.tid
      - valvesConfigTable.timestamp.timestamp
      - SPB_IRU_LIQUIDJETVALVEVALVE_SAMPLE_2.currentPosition.timestamp.tid
      - SPB_IRU_LIQUIDJETVALVEVALVE_SAMPLE_2.currentPosition.timestamp.timestamp
      - GROUPA.currentPosition.timestamp.tid
      - GROUPA.currentPosition.timestamp.timestamp

    SPB_XTD9_XGM/XGM/DOOCS:
      - pulseEnergy.wavelengthUsed.timestamp.tid
      - pulseEnergy.wavelengthUsed.timestamp.timestamp

    SPB_IRU_AGIPD1M/MDL/MOVER:
      - q4.x.timestamp.tid
      - q4.x.timestamp.timestamp
      - q4.y.timestamp.tid
      - q4.y.timestamp.timestamp
      - q1.y.timestamp.tid
      - q1.y.timestamp.timestamp
      - q1.x.timestamp.tid
      - q1.x.timestamp.timestamp
      - q2.y.timestamp.tid
      - q2.y.timestamp.timestamp
      - q2.x.timestamp.tid
      - q2.x.timestamp.timestamp
      - q3.y.timestamp.tid
      - q3.y.timestamp.timestamp
      - q3.x.timestamp.tid
      - q3.x.timestamp.timestamp

    SPB_DA_USR/MDL/AMARCORD_INFO:
      - darkExperiment.timestamp.tid
      - darkExperiment.timestamp.timestamp
      - darkRunNumber.timestamp.tid
      - darkRunNumber.timestamp.timestamp

OnDA:
